<html>
<head>
<!--
HACK: Preloading themes CSS's with an invalid media (hidden) , otherwise popup window enlarges
when loading it for the first time. (Don't know why...)
-->
<link rel="stylesheet" type="text/css" href="css/chromified.css" media="hidden" />
<link rel="stylesheet" type="text/css" href="css/whisper.css" id="theme" />
<link rel="stylesheet" type="text/css" href="css/sexy-combo.css" />
<script type="text/javascript" src="lib/jquery.js"></script>
<script type="text/javascript" src="lib/jquery.sexy-combo.js"></script>
<script type="text/javascript" src="lib/jquery-ui-custom.js"></script>
<script type="text/javascript" src="lib/jquery_replace_html.js"></script>
<!--script type="text/javascript" src="lib/debug.js"></script-->
<script type="text/javascript" src="lib/twitter_lib.js"></script>
<script>
$.fn.hoverFor = function(time, mainCallback, startingCallback, abortCallback) {
  return this.each(function(){
    var _this = this, timeoutHandle, triggerFired = false;
    $(this).hover(
      function() {
        if(triggerFired)
          return;
        if(startingCallback)
          startingCallback.call(_this);
        timeoutHandle = setTimeout(function() {
          triggerFired = true;
          mainCallback.call(_this);
          timeoutHandle = null;
        }, time);
      },
      function() {
        if(triggerFired)
          return;
        if(timeoutHandle) {
          if(abortCallback)
            abortCallback.call(_this);
          clearTimeout(timeoutHandle);
          timeoutHandle = null;
        }
      }
    );
 });
};

var tweetManager = chrome.extension.getBackgroundPage().TweetManager;
var tweetManagerConst = chrome.extension.getBackgroundPage().TweetManagerConstants;

Paginator = {
  firstPage: function() {
    tweetManager.currentPage = 1;
    $('#previousPage').hide();
  },
  nextPage: function() {
    tweetManager.currentPage += 1;
    $('#previousPage').show();
    loadTimeline();
  },
  setLastPage: function() {
    tweetManager.currentIsLastPage = true;
    $('#nextPage').hide();
  },
  previousPage: function() {
    tweetManager.currentIsLastPage = false;
    $('#nextPage').show();
    if(tweetManager.currentPage == 1) return;
    tweetManager.currentPage -= 1;
    if(tweetManager.currentPage == 1) {
      $('#previousPage').hide();
    }
    loadTimeline();
  },
  initialize: function() {
    if(tweetManager.currentPage == 1) {
      $('#previousPage').hide();
    }
    if(tweetManager.currentIsLastPage) {
      $('#nextPage').hide();
    }
  }
}

function showError(msg, tryAgainFunction) {
  $("#error").show();
  $("#error").text(msg);
  if(tryAgainFunction) {
    $("#error").append(' <a href="#" onclick="' + tryAgainFunction + '(); $(\'#error\').hide();">Try again</a>');
  }
}

function onTimelineRetrieved(tweets) {
  $("#loading").hide();
  if(tweets) {
    if(tweets.length == 0) {
      Paginator.previousPage();
    } else {
      assemblyTweets(tweets);
    }
    if(tweets.length < tweetManagerConst.TWEETS_PER_PAGE) {
      Paginator.setLastPage();
    }
  } else {
    showError('Unexpected error "' + chrome.extension.getBackgroundPage().TweetManager.currentError + '" during communication.', 'loadTimeline');
  }
}

function openTab(tabUrl) {
  chrome.tabs.create({ url: tabUrl });
}

function renderTweet(tweet) {
  var str = '<div id="tweet_' + tweet.id + '" class="tweet">';
  str += '<img src="' + tweet.user.profile_image_url + '" onclick="openTab(\'' + TwitterLib.URLS.BASE + tweet.user.screen_name + '\')"></img>';
  str += '<a href="#" class="user" onclick="openTab(\'' + TwitterLib.URLS.BASE + tweet.user.screen_name + '\')">' + tweet.user.screen_name + '</a>';
  str += '<div class="text">' + tweet.text + '</div>';

  str += '<div class="footer">';
  str += '<div class="timestamp">' + tweet.created_at + '</div>';
  str += '<div class="actions"><a href="#" onclick="retweet(this.parentNode.parentNode.parentNode)">RT</a> <a href="#" onclick="reply(this.parentNode.parentNode.parentNode)">Reply</a></div>'
  str += '</div>';

  str += '<div style="clear: both;"></div>'
  str += '</div>'
  return str;
}

function assemblyTweets(tweets) {
  $("#timeline").html('');
  for(var i = 0; i < tweets.length; ++i) {
    $("#timeline").append(renderTweet(tweets[i]));
  }

  var transformList = [
    {
      //create links
      'expression': /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,
      'replacement': "<a href='$1' onclick=\"openTab('$1')\">$1</a>"
    },
    {
      //create hash search links
      'expression': /(#\w*)/ig,
      'replacement': function(matchedValue) {
        var linkHref = TwitterLib.URLS.SEARCH + escape(matchedValue);
        return "<a href='" + linkHref + "' onclick=\"openTab('" + linkHref + "')\">" + matchedValue + "</a>"
      }
    },
    {
      //create users links
      'expression': /(@)(\w*)/ig,
      'replacement': "$1<a href='" + TwitterLib.URLS.BASE + "$2' onclick=\"openTab('" + TwitterLib.URLS.BASE + "$2')\">$2</a>"
    }
  ]

  for(var i = 0; i < transformList.length; ++i) {
    $("#timeline .tweet .text").replaceHtml(transformList[i].expression, transformList[i].replacement);
  }

  for(var unreadId in tweetManager.unreadTweets) {
    $("#tweet_" + unreadId).addClass('unread');
  }
  $(".tweet.unread").hoverFor(2000,
    function() {
      //Hovering for <time> seconds, let's read it.
      tweetManager.readTweet(this.id.split('_')[1]);
      $(this).removeClass('unread');
      $(this).attr('style', '');
    },
    function() {
      //Starting countdown to read
      var testEl = $("<div class='tweet' style='display:none'></div>")
      $(document.body).append(testEl);
      var transformation = {};
      jQuery.each(['backgroundColor', 'borderBottomColor', 'borderLeftColor', 'borderRightColor', 'borderTopColor', 'color', 'outlineColor'], function(i, attr) {
        var cssAttrName = attr.replace(/([A-Z])/g, '-$1').toLowerCase();
        var originValue = testEl.css(cssAttrName);
        if(originValue)
          transformation[attr] = originValue;
      });
      testEl.remove();
      $(this).animate(transformation, 2000);
    },
    function() {
      //Countdown aborted
      $(this).stop();
      $(this).attr('style', '');
    }
  );
}

function loadTimeline(force) {
  $("#loading").show();
  if(force) {
    Paginator.firstPage();
  }
  tweetManager.giveMeTweets(onTimelineRetrieved, force);
}

function sendTweet() {
  $("#loading").show();
  $("#compose_tweet_area input[type='button']").attr("disabled", "disabled");
  $("#compose_tweet_area textarea").attr("disabled", "disabled");
  var twitterBackend = chrome.extension.getBackgroundPage().getTwitterBackend();
  twitterBackend.tweet(function(success, data, status) {
    $("#loading").hide();
    $("#compose_tweet_area input[type='button']").removeAttr("disabled");
    $("#compose_tweet_area textarea").removeAttr("disabled");
    if(success) {
      $("#compose_tweet_area textarea").val("");
      textareaChanged();
      showComposeArea();
      loadTimeline(true);
    } else {
    }
  }, $("#compose_tweet_area textarea").val());
}

function clearUserData() {
  if(!$("input[name='remember']").is(":checked")) {
    localStorage.removeItem('remember');
    localStorage.removeItem('username');
    localStorage.removeItem('password');
    localStorage.removeItem('logged');
  }
}

function signin() {
  if($("input[name='remember']").is(":checked")) {
    localStorage.remember = true;
    localStorage.username = $("input[name='user']").val();
    localStorage.password = $("input[name='password']").val();
    localStorage.logged = true;
  }
  chrome.extension.getBackgroundPage().signin($("input[name='user']").val(), $("input[name='password']").val());
  loadTimeline();

  $("#signin").hide();
  $("#workspace").show();
}

function signout() {
  localStorage.removeItem('logged');
  chrome.extension.getBackgroundPage().signout();
  window.close();
}

function retweet(node) {
  showComposeArea(true);
  var el = $("#compose_tweet_area textarea");
  var user = $(".user", node).text();
  var msg = $(".text", node).text();
  el.val("RT @" + user + ": " + msg);
  textareaChanged();
}

function reply(node) {
  showComposeArea(true);
  var el = $("#compose_tweet_area textarea");
  var user = $(".user", node).text();
  el.val("@" + user + " ");
  textareaChanged();
}

function showComposeArea(showOnly) {
  if(!$("#compose_tweet_area").is(':visible')) {
    $("#compose_tweet_area").show('blind', { direction: "vertical" });
    $("#compose_tweet img").attr('src', 'img/arrow_up.gif');
    $("#compose_tweet_area textarea").focus();
  } else if(!showOnly) {
    $("#compose_tweet_area").hide('blind', { direction: "vertical" });
    $("#compose_tweet img").attr('src', 'img/arrow_down.gif');
  }
}

function textareaChanged() {
  var el = $("#compose_tweet_area textarea");
  var availableChars = tweetManagerConst.MAX_TWEET_SIZE - el.val().length;
  var charsLeftEl = $("#compose_tweet_area .chars_left");
  charsLeftEl.text(availableChars);
  if(availableChars < 0) {
    charsLeftEl.css('color', 'red');
    $("#compose_tweet_area input[type='button']").attr("disabled", "disabled");
  } else {
    charsLeftEl.css('color', 'black');
    $("#compose_tweet_area input[type='button']").removeAttr("disabled");
  }
}

function newTweetsAvailable(count) {
  var text = count + " more tweet";
  if(count > 1)
    text += "s";
  text += " available. Update now.";
  $("#update_tweets").text(text);
  $("#update_tweets").fadeIn();
}

function loadNewTweets() {
  Paginator.firstPage();
  tweetManager.updateNewTweets();
  $("#update_tweets").fadeOut();
  loadTimeline();
}

$(function() {
  var twitterBackend = chrome.extension.getBackgroundPage().getTwitterBackend();
  if(!twitterBackend) {
    $("#signin").show();
    $("input[name='user']").focus();

    if(localStorage.remember) {
      $("input[name='user']").val(localStorage.username);
      $("input[name='password']").val(localStorage.password);
      $("input[name='remember']").attr('checked', 'checked');
      if(localStorage.logged) {
        signin();
      }
    }
  } else {
    $("#workspace").show();
    if(tweetManager.newTweetsCount() > 0) {
      if(tweetManager.currentPage == 1) {
        tweetManager.updateNewTweets();
      } else {
        newTweetsAvailable(tweetManager.newTweetsCount());
      }
    }
    loadTimeline();
  }
  tweetManager.registerNewTweetsCallback(newTweetsAvailable);
  Paginator.initialize();
  textareaChanged();
  initTheme();
});

function initTheme() {
  var theme = localStorage.currentTheme;
  if(theme) {
    changeTheme(theme);
    $("select#theme_selector").val(theme);
  }
  $("select#theme_selector").sexyCombo({changeCallback: changeTheme});
}

function changeTheme(newCss) {
  if(!newCss) {
    newCss = this.getHiddenValue();
  }
  localStorage.currentTheme = newCss;
  var link_el = $("link#theme")[0]
  var new_link_el = $("<link rel='stylesheet' id='theme' type='text/css'>").attr("href", newCss)[0];
  link_el.parentNode.replaceChild(new_link_el, link_el);
}
</script>
</head>
<body>

<div id="signin" style="display: none;">
  <h1>Twitter credentials</h1>
  <label for="user">Username:</label>
  <input name="user" type="text"/>
  <label for="password">Password:</label>
  <input name="password" type="password"/>
  <input type="checkbox" name="remember" onclick="clearUserData();"/> Remember me

  <input value="Go!" type="button" onclick="signin()"/>
</div>

<div id="error" style="display: none;"></div>

<div id="workspace" style="display: none;">

  <div id="compose_tweet_area" style="display: none;">
    <textarea rows="4" onkeyup="textareaChanged();" onblur="textareaChanged();"></textarea>
    <div class="footer">
      <input type="button" value="Tweet it!" onclick="sendTweet();"/>
      <span class="chars_left"></span>
    </div>
  </div>
  <div id="compose_tweet" onclick="showComposeArea()">
    <img class="left" src="img/arrow_down.gif"/>
    Compose Tweet
    <img class="right" src="img/arrow_down.gif"/>
  </div>

  <div id="paginator">
    <img src="img/arrow_left.gif" id="nextPage" onclick="Paginator.nextPage();"/>
    <img src="img/none.gif"/>
    <img src="img/arrow_right.gif" id="previousPage" onclick="Paginator.previousPage();"/>
  </div>
  <div id="logout"><a href="#" onclick="signout()">Log out</a></div>
  <img src="img/loading.gif" id="loading" style="display: none;"/>
  <div style="clear: both;"></div>

  <div id="update_tweets" onclick="loadNewTweets();"></div>

  <select id="theme_selector">
    <option value="css/whisper.css">Whispers (Default)</option>
    <option value="css/chromified.css">Chromified</option>
  </select>
  <div id="timeline"></div>
</div>
</body>
</html>