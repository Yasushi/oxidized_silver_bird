<!DOCTYPE html>

<html>

<head>
<link rel="stylesheet" type="text/css" href="css/options.css" />
<link rel="stylesheet" type="text/css" href="css/colorpicker/colorpicker.css" />
<script type="text/javascript" src="lib/3rdparty/jquery.js"></script>
<script type="text/javascript" src="lib/3rdparty/colorpicker.js"></script>
<script type="text/javascript" src="lib/shortener_lib.js"></script>
<title>Chromed Bird Options</title>

<script type="text/javascript">

var OptionsBackend = chrome.extension.getBackgroundPage().OptionsBackend;

function Options() {
  this.optionsMap = {};

  this.load = function(forceDefault) {
    this.optionsMap = OptionsBackend.load(forceDefault);
    var _this = this;
    $('input,select,canvas.color_selector').each(function() {
      var $this = $(this);
      var name = $this.attr('name');
      if(name) {
        if($this.is('[type="checkbox"]')) {
          $this.attr('checked', _this.optionsMap[name]);
        } else if($this.is('canvas')) {
          /*$("div", $this)
            .css('backgroundColor', _this.optionsMap[name])
            .attr('hexColor', _this.optionsMap[name]);*/
          $this.attr('hexColor', _this.optionsMap[name]);
          paintIcon($this[0], _this.optionsMap[name]);
          $this.ColorPickerSetColor(_this.optionsMap[name]);
        } else {
          $this.val(_this.optionsMap[name]);
        }
      }
    });
  };

  this.loadDefaults = function() {
    this.load(true);
    this.save();
  };

  this.save = function() {
    this.clearErrors();
    var hasErrors = false;
    var _this = this;
    $('input,select').each(function() {
      var $this = $(this);
      var validator = $this.attr('validator');
      if(validator) {
        var validatorsArray = validator.split(',');
        for(var i = 0; i < validatorsArray.length; ++i) {
          var validInfo = Validator[validatorsArray[i]]($this);
          if(validInfo !== true) {
            hasErrors = true;
            _this.addValidationError($this, validInfo);
            return true;
          }
        }
      }
    });
    if(!hasErrors) {
      $('input,select,canvas.color_selector').each(function() {
        var $this = $(this);
        var name = $this.attr('name');
        if(name) {
          if($this.is('[type="checkbox"]')) {
             _this.optionsMap[name] = $this.attr('checked');
          } else if($this.is('canvas')) {
            _this.optionsMap[name] = $this.attr('hexColor');
          } else {
            var elValue = $this.val();
            var intValue = parseInt(elValue );
            if(intValue == elValue) {
              elValue = intValue;
            }
            _this.optionsMap[name] = elValue;
          }
        }
      });
      OptionsBackend.save(this.optionsMap);
      $(document).scrollTop(0);
      $("#saved_notice").stop().show().css('opacity', '1.0').fadeOut(5000);
    }
  };

  this.addValidationError = function($el, error) {
    var errorEl = $("<span>").attr('class', 'error').html(error);
    $el.after(errorEl);
  };

  this.clearErrors = function() {
    $('.error').remove();
  };

}

/* ---- validation ---- */
Validator = {
  required: function ($el) {
    var val = $el.val()
    if(!val)
      return 'It can\'t be empty.';
    return true;
  },

  number: function ($el) {
    var intVal = parseInt($el.val());
    if(isNaN(intVal))
      return 'It should be a number.';
    return true;
  },

  positive: function ($el) {
    if(parseInt($el.val()) <= 0)
      return 'It should be positive.';
    return true;
  },

  minRefresh: function ($el) {
    if(parseInt($el.val()) < 20000)
      return 'Minimum interval is 20000ms';
    return true;
  },

  url: function ($el) {
    if($el.val().match(/(\b(https?):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/i)) {
      return true;
    }
    return 'It should be a valid URL.';
  }
}
/* ---- end validation ---- */

var IconCreator = chrome.extension.getBackgroundPage().IconCreator;
var twitterBackend = chrome.extension.getBackgroundPage().TweetManager.instance.twitterBackend;
var options = new Options();
var imgEl = null;

function paintIcon(canvas, color) {
  if(!imgEl) {
    var img = $('<img>').attr('src', 'img/icon19.png');
    img.load(function() {
      imgEl = img[0];
      var imgData = IconCreator.paintIcon(imgEl, color);
      canvas.getContext("2d").putImageData(imgData, 0, 0);
    });
  } else {
    var imgData = IconCreator.paintIcon(imgEl, color);
    canvas.getContext("2d").putImageData(imgData, 0, 0);
  }
}

$(function() {
  if(twitterBackend) {
    var hitsInfo = twitterBackend.remainingHitsInfo();
    $(".twitter_hits_left").text(hitsInfo[0]);
    var dateObj = new Date();
    dateObj.setTime(parseInt(hitsInfo[1]) * 1000);
    $(".twitter_hits_reset").text(dateObj.toLocaleDateString() + " " + dateObj.toLocaleTimeString());
  }
  for(var key in SHORTENERS_BACKEND) {
    var desc = SHORTENERS_BACKEND[key].desc;
    $("select[name='url_shortener']").append($("<option>").attr('value', key).text(desc));
  }
  $('canvas.color_selector').ColorPicker({
    onChange: function (hsb, hex, rgb) {
      var canvas = this.data('colorpicker').el;
      $(canvas).attr('hexColor', '#' + hex);
      paintIcon(canvas, rgb);
    }
  });
  options.load();
});
</script>

</head>
<body>

<h1>Chromed Bird Options</h1>

<div id="saved_notice">Your configuration has been successfully saved!</div>
<div id="main_area">
  <p class="notice">
    Please notice that options denoted with asterisk "*" will only take effect if you restart the extension. (Disabling and enabling it again)
  </p>
  <p>
    Remaining Twitter API Hits: <span class="twitter_hits_left"></span><br>
    Rate Limit Reset: <span class="twitter_hits_reset"></span>
  </p>

   <fieldset>
    <legend>UI</legend>
    <label for="name_attribute">Name in tweets:</label>
    <select name="name_attribute">
      <option value="screen_name">Screen name (nickname)</option>
      <option value="name">Real name</option>
    </select><br>
    <label for="compose_position">Compose area position:</label>
    <select name="compose_position">
      <option value="top">Top</option>
      <option value="bottom">Bottom</option>
    </select><br>
    <label>*Icon color:</label>
    <canvas name="idle_color" width="19" height="19" class="color_selector"></canvas>
  </fieldset>

  <fieldset>
    <legend>Notifications</legend>
    <table>
      <tr>
        <th></th>
        <th>Show on Page</th>
        <th>Change Icon</th>
        <th>Icon Color</th>
      <tr>
        <td class="label">Home:</td>
        <td><input type="checkbox" name="home_on_page"></td>
        <td><input type="checkbox" name="home_icon"></td>
        <td><canvas name="home_color" width="19" height="19" class="color_selector"></canvas></td>
      </tr>
      <tr>
        <td class="label">Mentions:</td>
        <td><input type="checkbox" name="mentions_on_page"></td>
        <td><input type="checkbox" name="mentions_icon"></td>
        <td><canvas name="mentions_color" width="19" height="19" class="color_selector"></canvas></td>
      </tr>
      <tr>
        <td class="label">DMs:</td>
        <td><input type="checkbox" name="dms_on_page"></td>
        <td><input type="checkbox" name="dms_icon"></td>
        <td><canvas name="dms_color" width="19" height="19" class="color_selector"></canvas></td>
      </tr>
    </table>
  </fieldset>

  <fieldset>
    <legend>Shortener</legend>
    <label for="url_shortener">URL Shortener:</label>
    <select name="url_shortener"></select>
  </fieldset>

  <fieldset>
    <legend>Refresh Interval (ms)</legend>
    <p class="notice">
      Be careful with API hits limit!
    </p>
    <label for="home_refresh_interval">*Home Timeline:</label>
    <input type="text" name="home_refresh_interval" validator="required,number,minRefresh"><br>
    <label for="mentions_refresh_interval">*Mentions Timeline:</label>
    <input type="text" name="mentions_refresh_interval" validator="required,number,minRefresh"><br>
    <label for="dms_refresh_interval">*DM Timeline:</label>
    <input type="text" name="dms_refresh_interval" validator="required,number,minRefresh"><br>
  </fieldset>

  <fieldset>
    <legend>Timelines</legend>
    <label for="tweets_per_page">*Tweets per Page:</label>
    <input type="text" name="tweets_per_page" validator="required,number,positive"><br>
    <label for="max_cached_tweets">*Max Shown Tweets:</label>
    <input type="text" name="max_cached_tweets" validator="required,number,positive"><br>
  </fieldset>

  <fieldset>
    <legend>Advanced</legend>
    <label for="request_timeout">*Request Timeout (ms):</label>
    <input type="text" name="request_timeout" validator="required,number,positive"><br>
    <label for="base_url">*Twitter's API URL:</label>
    <input type="text" name="base_url" style="width: 300px;" validator="required,url"><br>
    <label for="base_signing_url">*OAuth Signature URL:</label>
    <input type="text" name="base_signing_url" style="width: 300px;" validator="required,url"><br>
    <label for="base_authorize_url">*OAuth Authorize URL:</label>
    <input type="text" name="base_authorize_url" style="width: 300px;" validator="required,url"><br>
  </fieldset>

  <br>
  <input type="button" value="Save" onclick="options.save();">
  <input type="button" value="Reset" onclick="options.load();">
  <input type="button" value="Reset to default" onclick="options.loadDefaults();">
</div>

</body>
</html>